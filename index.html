<html>
    <body>
        <script>
            function getBlob() {
                return fetch("file.bin")
                .then(resp => resp.blob())
                .catch(console.error);
            }
            async function decompress() {
                const blob = await getBlob();
                console.log("got blob", blob);
                const decompressed = await decompressBlob(blob);

                const reader = new FileReader();
                reader.onload = function() {
                    console.log(reader.result);
                }
                reader.readAsText(decompressed);
            }
            function decompressBlob(blob) {
                const ds = new DecompressionStream('gzip');
                const decompressionStream = blob.stream().pipeThrough(ds);
                return new Response(decompressionStream).blob();
            }
            async function compressArrayBuffer(input) {
                const cs = new CompressionStream('gzip');
                const writer = cs.writable.getWriter();
                writer.write(input);
                writer.close();
                const output = [];
                const reader = cs.readable.getReader();
                let totalSize = 0;
                while (true) {
                    const { value, done } = await reader.read();
                    if (done)
                    break;
                    output.push(value);
                    totalSize += value.byteLength;
                }
                const concatenated = new Uint8Array(totalSize);
                let offset = 0;
                for (const array of output) {
                    concatenated.set(array, offset);
                    offset += array.byteLength;
                }
                return concatenated;
            }
        
        const downloadBlob = function(data, fileName, mimeType) {
          var blob, url;
          blob = new Blob([data], {
            type: mimeType
          });
          url = window.URL.createObjectURL(blob);
          downloadURL(url, fileName);
          setTimeout(function() {
            return window.URL.revokeObjectURL(url);
          }, 1000);
        };
        
        const downloadURL = function(data, fileName) {
          var a;
          a = document.createElement('a');
          a.href = data;
          a.download = fileName;
          document.body.appendChild(a);
          a.style = 'display: none';
          a.click();
          a.remove();
        };

        function getJSON() {
            return fetch("holy_bible.json").then(resp => resp.text());
        }

        async function compress() {
            const text = await getJSON();

            const enc = new TextEncoder(); // always utf-8
            const ua = enc.encode(text);
       
            const compressed = await compressArrayBuffer(ua.buffer);
            downloadBlob(compressed, 'holy_bible.bin', 'application/octet-stream');
        }

        window.onload = decompress;
        </script>
        
    </body>
</html>
